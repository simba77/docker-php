# Traefik

Traefik выступает в роли обратного прокси-сервера, автоматически маршрутизируя запросы к локальным доменам в соответствующие контейнеры.

## Принцип работы

1.  **Запуск Traefik:** Traefik запускается как контейнер Docker Compose и прослушивает входящие HTTP/HTTPS-запросы.
2.  **Маршрутизация запросов:** Traefik анализирует заголовки `Host` в запросах и на основе правил, определенных в `docker-compose.yml`, перенаправляет запросы в нужные контейнеры PHP-приложений.
3.  **Управление доменами:** Traefik позволяет использовать удобные локальные домены (например, `myapp.loc`) вместо `localhost:port` для доступа к приложениям.

## Настройка и запуск

1.  **Размещение конфигурации:** Рекомендуется разместить папку `traefik/` отдельно от проекта PHP-приложения.
2.  **Запуск Traefik:** Запустите контейнер Traefik с помощью Docker Compose:

    ```bash
    docker compose up -d
    ```

3.  **Проверка сети:** После запуска должна появиться сеть `traefik_default`. Все контейнеры PHP-приложений, которые должны быть доступны через Traefik, должны быть подключены к этой сети.

    * Если сеть не создалась автоматически, создайте её вручную:

        ```bash
        docker network create traefik_default --label "com.docker.compose.network=default"
        ```

4.  **Автоматический запуск:** Traefik настроен на автоматический запуск при перезапуске Docker или компьютера (`restart: always`). При необходимости измените этот параметр в `docker-compose.yml`.

## Включенные сервисы

* **Adminer:** Веб-интерфейс для управления базами данных MariaDB. Доступен по адресу `https://adminer.loc`.
    * Добавьте запись в файл `hosts`: `127.0.0.1 adminer.loc`.
    * В окне авторизации Adminer:
        * `Server`: имя контейнера MariaDB.
        * `Username/Password`: учетные данные из `.env` или значения по умолчанию из `docker-compose.yml`.
* **MailHog:** Инструмент для перехвата и просмотра исходящих писем из PHP-приложений. Доступен по адресу `http://localhost:8025`.
    * Редирект писем настраивается в файле `php.ini` (`.docker/php-fpm/app.dev.ini`).

## Настройка HTTPS с mkcert

1.  **Установка mkcert:** Установите утилиту `mkcert` ([https://github.com/FiloSottile/mkcert](https://github.com/FiloSottile/mkcert)) для генерации локальных SSL-сертификатов.
2.  **Генерация сертификатов:** Сгенерируйте сертификаты для локальных доменов:

    ```bash
    mkcert -cert-file certs/local-cert.pem -key-file certs/local-key.pem "localhost" "*.localhost" "adminer.loc" "myapp.loc" "yourdomain.loc"
    ```

    * Перечислите все необходимые домены через пробел.
    * Wildcard-сертификаты для корневых доменов (`*.loc`) могут не работать в некоторых браузерах.

3.  **Использование Makefile:** В `Makefile` уже есть команда `gen-cert` для удобной генерации сертификатов. Отредактируйте её, добавив нужные домены в список:

    ```makefile
    gen-cert:
        mkcert -cert-file certs/local-cert.pem -key-file certs/local-key.pem "localhost" "*.localhost" "adminer.loc" "myapp.loc" "yourdomain.loc"
    ```

    * Затем выполните команду `make gen-cert`.

4.  **Перезапуск Traefik:** После генерации сертификатов необходимо перезапустить контейнер Traefik, чтобы он подхватил новые сертификаты, используя команду `make restart`:

    ```bash
    make restart
    ```

5.  **Доступ по HTTPS:** После перезапуска контейнера локальные сайты будут доступны по HTTPS без предупреждений о недоверенном сертификате в браузере.